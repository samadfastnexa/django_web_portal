<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Policies</title>
  <style>
    :root { --bg: #0f172a; --fg: #e2e8f0; --muted: #94a3b8; --accent: #38bdf8; --danger: #ef4444; }
    body { background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 14px; }
    h1 { font-size: 20px; margin: 0; }
    .actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-sync { background: var(--accent); color: #0b1220; }
    .btn-sync[disabled] { opacity: 0.6; cursor: not-allowed; }
    .search { flex: 1; min-width: 180px; }
    .search input, .filters select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1220; color: var(--fg); }
    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .card { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; overflow: hidden; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 10px; border-bottom: 1px solid #1f2937; text-align: left; }
    .table th { font-size: 12px; text-transform: uppercase; color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .badge-active { background: #16a34a22; color: #22c55e; border: 1px solid #14532d; }
    .badge-inactive { background: #ef444422; color: #ef4444; border: 1px solid #7f1d1d; }
    .footer { display: flex; justify-content: space-between; padding: 10px; color: var(--muted); font-size: 13px; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #0b1220; border: 1px solid #1f2937; color: var(--fg); padding: 12px 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .spinner { width: 16px; height: 16px; border: 2px solid var(--accent); border-top-color: transparent; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 640px) { .hide-sm { display: none; } .table th, .table td { font-size: 14px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Policies</h1>
      <div class="actions">
        <button id="syncBtn" class="btn btn-sync">Sync</button>
        <span id="syncState" style="display:none"><span class="spinner"></span> Syncing...</span>
      </div>
      <div class="search">
        <input id="searchInput" type="text" placeholder="Search policy code/name/policy" />
      </div>
      <div class="filters">
        <select id="activeFilter">
          <option value="">All Status</option>
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
        <input id="fromFilter" type="date" />
        <input id="toFilter" type="date" />
      </div>
    </div>

    <div class="card">
      <table class="table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th class="hide-sm">Policy</th>
            <th>Valid From</th>
            <th>Valid To</th>
            <th>Status</th>
            <th class="hide-sm">Updated</th>
          </tr>
        </thead>
        <tbody id="policyBody">
          <tr><td colspan="7" style="color:var(--muted)">Loading...</td></tr>
        </tbody>
      </table>
      <div class="footer">
        <div id="countBox">0 policies</div>
        <div id="statusBox">Ready</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    const API_LIST = '/api/sap/policy-records/';
    const API_SYNC = '/api/sap/policies/sync/';

    const policyBody = document.getElementById('policyBody');
    const countBox = document.getElementById('countBox');
    const statusBox = document.getElementById('statusBox');
    const syncBtn = document.getElementById('syncBtn');
    const syncState = document.getElementById('syncState');
    const toast = document.getElementById('toast');

    const searchInput = document.getElementById('searchInput');
    const activeFilter = document.getElementById('activeFilter');
    const fromFilter = document.getElementById('fromFilter');
    const toFilter = document.getElementById('toFilter');

    function showToast(msg, isError=false) {
      toast.textContent = msg;
      toast.style.borderColor = isError ? '#7f1d1d' : '#1f2937';
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function fetchPolicies() {
      statusBox.textContent = 'Loading policies…';
      const params = new URLSearchParams();
      if (searchInput.value) params.set('search', searchInput.value);
      if (activeFilter.value) params.set('active', activeFilter.value);
      if (fromFilter.value) params.set('valid_from', fromFilter.value);
      if (toFilter.value) params.set('valid_to', toFilter.value);

      try {
        const resp = await fetch(`${API_LIST}?${params.toString()}`, { credentials: 'same-origin' });
        const json = await resp.json();
        if (!json.success) throw new Error(json.message || 'Failed to load');
        renderPolicies(json.data);
        countBox.textContent = `${json.count} policies`;
        statusBox.textContent = 'Loaded';
      } catch (e) {
        policyBody.innerHTML = `<tr><td colspan="7" style="color:var(--danger)">${e.message}</td></tr>`;
        statusBox.textContent = 'Error loading';
        showToast(`Error: ${e.message}`, true);
      }
    }

    function renderPolicies(rows) {
      if (!rows || !rows.length) {
        policyBody.innerHTML = '<tr><td colspan="7" style="color:var(--muted)">No policies found</td></tr>';
        return;
      }
      policyBody.innerHTML = rows.map(r => {
        const activeBadge = r.active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
        const vf = r.valid_from || '';
        const vt = r.valid_to || '';
        const updated = (r.updated_at || '').replace('T',' ').split('.')[0];
        return `<tr>
          <td>${r.code || ''}</td>
          <td>${r.name || ''}</td>
          <td class="hide-sm">${r.policy || ''}</td>
          <td>${vf}</td>
          <td>${vt}</td>
          <td>${activeBadge}</td>
          <td class="hide-sm">${updated}</td>
        </tr>`;
      }).join('');
    }

    async function doSync() {
      syncBtn.disabled = true;
      syncState.style.display = 'inline-block';
      statusBox.textContent = 'Syncing…';

      try {
        const resp = await fetch(API_SYNC, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        const json = await resp.json();
        if (!json.success) throw new Error(json.message || 'Sync failed');
        showToast(`Sync completed. Created: ${json.created}, Updated: ${json.updated}`);
        await fetchPolicies();
        statusBox.textContent = 'Synced';
      } catch (e) {
        showToast(`Error: ${e.message}`, true);
        statusBox.textContent = 'Sync error';
      } finally {
        syncBtn.disabled = false;
        syncState.style.display = 'none';
      }
    }

    syncBtn.addEventListener('click', doSync);
    searchInput.addEventListener('input', () => { fetchPolicies(); });
    activeFilter.addEventListener('change', () => { fetchPolicies(); });
    fromFilter.addEventListener('change', () => { fetchPolicies(); });
    toFilter.addEventListener('change', () => { fetchPolicies(); });

    fetchPolicies();
  </script>
</body>
</html>