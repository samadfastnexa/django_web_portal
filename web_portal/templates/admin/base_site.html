{% extends "admin/base.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script>
    // Apply stored theme ASAP to avoid flash
    (function(){
      try {
        var html = document.documentElement;
        var key = 'admin_theme_mode';
        var stored = localStorage.getItem(key);
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        html.setAttribute('data-theme', stored ? stored : (prefersDark ? 'dark' : 'light'));
      } catch(e) {}
    })();
  </script>
  <link rel="stylesheet" href="{% static 'sap_integration/admin.css' %}">
  <script>
    (function() {
      function ready(fn){ if(document.readyState !== 'loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
      ready(function(){
        // Theme toggle
        try {
          var userTools = document.getElementById('user-tools');
          var html = document.documentElement;
          var STORAGE_KEY = 'admin_theme_mode';
          if (userTools) {
            // Clean up stray icon-only boxes from plugins
            try {
              Array.prototype.slice.call(userTools.querySelectorAll('button, a')).forEach(function(el){
                var isTheme = el.classList && el.classList.contains('theme-toggle');
                var isPwd = el.classList && el.classList.contains('password-toggle');
                var hasIconOnly = (!el.textContent || el.textContent.trim() === '') && !!el.querySelector('svg, img, span');
                var sizeBox = (el.offsetWidth && el.offsetWidth <= 36) && (el.offsetHeight && el.offsetHeight <= 36);
                if (!isTheme && !isPwd && hasIconOnly && sizeBox) { el.remove(); }
              });
            } catch(e) {}

            var toggle = userTools.querySelector('.theme-toggle');
            if (!toggle) {
              toggle = document.createElement('button');
              toggle.type = 'button';
              toggle.className = 'theme-toggle';
              userTools.appendChild(toggle);
            }
            // Ensure semantics and clean styles even if pre-existing button was injected by a plugin
            toggle.setAttribute('role', 'switch');
            toggle.setAttribute('aria-checked', 'false');
            toggle.setAttribute('aria-label', 'Switch to dark mode');
            toggle.style.background = 'transparent';
            toggle.style.backgroundColor = 'transparent';
            toggle.style.backgroundImage = 'none';
            toggle.style.border = '0';
            // Always (re)inject our icon markup to avoid empty boxes
            toggle.innerHTML = (
              '<svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">'
              + '<g fill="currentColor">'
              + '<circle cx="12" cy="12" r="5"/>'
              + '<rect x="11" y="1" width="2" height="4" rx="1"/>'
              + '<rect x="11" y="19" width="2" height="4" rx="1"/>'
              + '<rect x="1" y="11" width="4" height="2" rx="1"/>'
              + '<rect x="19" y="11" width="4" height="2" rx="1"/>'
              + '<rect x="3.5" y="3.5" width="2.5" height="2.5" rx="1" transform="rotate(-45 4.75 4.75)"/>'
              + '<rect x="18" y="18" width="2.5" height="2.5" rx="1" transform="rotate(-45 19.25 19.25)"/>'
              + '<rect x="18" y="3.5" width="2.5" height="2.5" rx="1" transform="rotate(45 19.25 4.75)"/>'
              + '<rect x="3.5" y="18" width="2.5" height="2.5" rx="1" transform="rotate(45 4.75 19.25)"/>'
              + '</g>'
              + '</svg>'
              + '<svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">'
              + '<path fill="currentColor" d="M21 12.5A9 9 0 0 1 9.5 3c-.3 0-.6 0-.9.1a1 1 0 0 0-.2 1.8A7 7 0 0 0 12 21a9 9 0 0 0 9-8.5 1 1 0 0 0-1-.9z"/>'
              + '</svg>'
            );
            // Marker for CSS to disable pseudo-element fallbacks
            toggle.classList.add('has-svg');
            // Fallback to emoji if SVGs do not render
            try {
              if (!toggle.querySelector('.icon-sun') || !toggle.querySelector('.icon-moon')) {
                toggle.innerHTML = '<span class="icon-sun" aria-hidden="true">â˜€</span>' + '<span class="icon-moon" aria-hidden="true">ðŸŒ™</span>';
                toggle.classList.remove('has-svg');
              }
            } catch(err) {
              toggle.innerHTML = '<span class="icon-sun" aria-hidden="true">â˜€</span>' + '<span class="icon-moon" aria-hidden="true">ðŸŒ™</span>';
              toggle.classList.remove('has-svg');
            }

            function applyTheme(mode){
              html.setAttribute('data-theme', mode);
              var dark = mode === 'dark';
              toggle.setAttribute('aria-checked', dark ? 'true' : 'false');
              toggle.setAttribute('aria-label', dark ? 'Switch to light mode' : 'Switch to dark mode');
            }
            var stored = localStorage.getItem(STORAGE_KEY);
            var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            var initial = stored ? stored : (prefersDark ? 'dark' : 'light');
            applyTheme(initial);

            toggle.addEventListener('click', function(){
              var next = (html.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
              localStorage.setItem(STORAGE_KEY, next);
              applyTheme(next);
              try { toggle.setAttribute('aria-live', 'polite'); } catch(e) {}
            });
          }
        } catch(e) { /* silent */ }

        // Login: show/hide password eye icon
        var pwd = document.getElementById('id_password');
        if(!pwd) return; // only on login page

        var wrapper = document.createElement('span');
        wrapper.className = 'password-field-wrapper';
        pwd.parentNode.insertBefore(wrapper, pwd);
        wrapper.appendChild(pwd);
        try { pwd.style.paddingRight = '40px'; } catch(e) {}

        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'password-toggle';
        btn.setAttribute('aria-label', 'Show password');
        btn.setAttribute('aria-controls', 'id_password');
        btn.setAttribute('data-state', 'hidden');
        btn.innerHTML = (
          '<svg class="icon-eye" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">'
          + '<path fill="currentColor" d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/>'
          + '</svg>'
          + '<svg class="icon-eye-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">'
          + '<path fill="currentColor" d="M2 4.27L3.28 3 21 20.72 19.73 22l-3.88-3.88A11.86 11.86 0 0112 19c-5 0-9.27-3.11-11-7a12.7 12.7 0 013.44-4.53L2 4.27z"/>'
          + '<path fill="currentColor" d="M12 5c5 0 9.27 3.11 11 7-.93 2.1-2.55 3.93-4.53 5.15l-1.42-1.42A8.03 8.03 0 0020 12c-1.73-3.89-6-7-8-7-1.18 0-2.3.21-3.33.59L7.7 4.9A10.2 10.2 0 0112 5z"/>'
          + '</svg>'
        );
        btn.addEventListener('click', function(){
          var isHidden = pwd.type === 'password';
          pwd.type = isHidden ? 'text' : 'password';
          btn.setAttribute('data-state', isHidden ? 'visible' : 'hidden');
          btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
        });
        wrapper.appendChild(btn);
      });
    })();
  </script>
{% endblock %}

{% block branding %}
  <h1 id="site-name"><a href="{% url 'admin:index' %}">Tarzan Administration</a></h1>
{% endblock %}